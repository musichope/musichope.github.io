<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐仓库 | GitHub音乐播放器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 用于读取音乐元数据的库 -->
    <script src="https://cdn.jsdelivr.net/npm/music-metadata-browser@2.2.1/dist/music-metadata-browser.min.js"></script>
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        secondary: '#10B981',
                        dark: '#1E293B',
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .progress-bar {
                height: 4px;
                background: #CBD5E1;
                border-radius: 2px;
                cursor: pointer;
            }
            .progress-fill {
                height: 100%;
                background: #2563EB;
                width: 0%;
                transition: width 0.1s linear;
            }
            .upload-zone {
                border: 2px dashed #94A3B8;
                transition: all 0.3s ease;
            }
            .upload-zone:hover, .upload-zone.active {
                border-color: #2563EB;
                background-color: rgba(37, 99, 235, 0.05);
            }
            .song-item {
                transition: background-color 0.2s ease;
            }
            .song-item:hover {
                background-color: rgba(37, 99, 235, 0.05);
            }
            .album-art {
                transition: transform 0.3s ease;
            }
            .album-art:hover {
                transform: scale(1.03);
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans text-dark">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 页面标题 -->
        <header class="text-center mb-10">
            <div class="flex items-center justify-center mb-2">
                <i class="fa fa-music text-primary text-2xl mr-2"></i>
                <h1 class="text-3xl font-bold">音乐仓库</h1>
            </div>
            <p class="text-gray-500">上传音乐，自动识别信息，在线播放</p>
        </header>
        
        <!-- 上传区域 -->
        <div id="uploadZone" class="upload-zone rounded-xl p-8 text-center mb-10">
            <input type="file" id="fileInput" accept="audio/*" class="hidden" multiple>
            <label for="fileInput" class="cursor-pointer block">
                <div class="flex flex-col items-center">
                    <i class="fa fa-cloud-upload text-5xl text-primary mb-4"></i>
                    <h3 class="text-lg font-medium mb-2">拖放音乐文件到这里，或点击上传</h3>
                    <p class="text-gray-500 text-sm max-w-md mb-6">支持 MP3、WAV、FLAC 等格式，会自动识别歌曲名称、艺术家等信息</p>
                    <button class="px-6 py-3 bg-primary text-white rounded-full hover:bg-primary/90 transition-colors shadow-md hover:shadow-lg">
                        选择音乐文件
                    </button>
                </div>
            </label>
        </div>
        
        <!-- 播放器区域 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-10">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- 专辑封面 -->
                <div class="w-full md:w-48 h-48 md:flex-shrink-0">
                    <img src="https://picsum.photos/id/1074/300/300" alt="专辑封面" class="w-full h-full object-cover rounded-lg shadow album-art" id="albumCover">
                </div>
                
                <!-- 播放控制 -->
                <div class="flex-1 flex flex-col justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-dark mb-1 truncate" id="currentTitle">未播放音乐</h2>
                        <p class="text-gray-500 mb-4" id="currentArtist">请上传音乐文件开始播放</p>
                        
                        <!-- 进度条 -->
                        <div class="mb-4">
                            <div class="flex justify-between text-sm text-gray-500 mb-2">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                            <div class="progress-bar" id="progressBar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 控制按钮 -->
                    <div>
                        <div class="flex justify-center items-center space-x-6 mb-4">
                            <button id="prevBtn" class="text-gray-600 hover:text-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fa fa-step-backward text-xl"></i>
                            </button>
                            <button id="playPauseBtn" class="w-14 h-14 rounded-full bg-primary text-white flex items-center justify-center hover:bg-primary/90 transition-colors shadow-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fa fa-play text-xl"></i>
                            </button>
                            <button id="nextBtn" class="text-gray-600 hover:text-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fa fa-step-forward text-xl"></i>
                            </button>
                        </div>
                        
                        <!-- 音量控制 -->
                        <div class="flex items-center justify-center space-x-3">
                            <button id="muteBtn" class="text-gray-600 hover:text-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fa fa-volume-up"></i>
                            </button>
                            <input type="range" min="0" max="100" value="80" class="w-32 accent-primary" id="volumeSlider" disabled>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 歌曲列表 -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <h3 class="text-lg font-semibold px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <span>我的音乐库</span>
                <span id="songCount" class="text-sm font-normal text-gray-500">0 首歌曲</span>
            </h3>
            
            <!-- 空库提示 -->
            <div id="emptyLibrary" class="py-20 text-center text-gray-500">
                <i class="fa fa-music text-5xl mb-4 opacity-30"></i>
                <p class="mb-2">音乐库还是空的</p>
                <p class="text-sm">上传一些音乐来填充你的音乐库吧</p>
            </div>
            
            <!-- 歌曲列表 -->
            <ul id="songList" class="divide-y hidden">
                <!-- 歌曲项将通过JavaScript动态生成 -->
            </ul>
            
            <!-- 加载中提示 -->
            <div id="loadingIndicator" class="py-20 text-center hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-r-transparent"></div>
                <p class="mt-3 text-gray-500">加载音乐中...</p>
            </div>
        </div>
        
        <!-- 操作提示 -->
        <div class="mt-8 text-center text-sm text-gray-500">
            <p>所有音乐文件存储在您的浏览器本地，不会上传到服务器</p>
            <p class="mt-1">刷新页面后音乐仍然可用，清除浏览器数据会删除音乐</p>
        </div>
    </div>
    
    <!-- 音频元素 -->
    <audio id="audioPlayer" preload="metadata">
        您的浏览器不支持音频播放
    </audio>

    <script>
        // DOM元素
        const fileInput = document.getElementById('fileInput');
        const uploadZone = document.getElementById('uploadZone');
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const currentTitle = document.getElementById('currentTitle');
        const currentArtist = document.getElementById('currentArtist');
        const albumCover = document.getElementById('albumCover');
        const volumeSlider = document.getElementById('volumeSlider');
        const muteBtn = document.getElementById('muteBtn');
        const songList = document.getElementById('songList');
        const songCount = document.getElementById('songCount');
        const emptyLibrary = document.getElementById('emptyLibrary');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        // 音乐库数据
        let musicLibrary = [];
        let currentSongIndex = -1;
        let isDragging = false;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 从本地存储加载音乐库
            loadMusicLibrary();
            
            // 事件监听
            setupEventListeners();
        });
        
        // 设置事件监听
        function setupEventListeners() {
            // 文件上传相关
            fileInput.addEventListener('change', handleFileUpload);
            
            // 拖放功能
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleDrop);
            
            // 播放控制
            playPauseBtn.addEventListener('click', togglePlayPause);
            prevBtn.addEventListener('click', playPreviousSong);
            nextBtn.addEventListener('click', playNextSong);
            
            // 进度控制
            audioPlayer.addEventListener('timeupdate', updateProgress);
            progressBar.addEventListener('click', seekTo);
            progressBar.addEventListener('mousedown', () => isDragging = true);
            document.addEventListener('mouseup', () => isDragging = false);
            
            // 音量控制
            volumeSlider.addEventListener('input', adjustVolume);
            muteBtn.addEventListener('click', toggleMute);
            
            // 播放结束自动下一首
            audioPlayer.addEventListener('ended', playNextSong);
        }
        
        // 处理文件上传
        async function handleFileUpload(e) {
            const files = e.target.files;
            if (!files.length) return;
            
            showLoading();
            
            // 处理每个文件
            for (let i = 0; i < files.length; i++) {
                await processAudioFile(files[i]);
            }
            
            // 重置输入，允许重复选择同一文件
            fileInput.value = '';
            
            // 更新UI
            updateMusicLibraryUI();
            hideLoading();
            
            // 如果是首次上传，自动播放第一首
            if (musicLibrary.length === files.length) {
                playSong(0);
            }
        }
        
        // 处理拖放 - 悬停时
        function handleDragOver(e) {
            e.preventDefault();
            uploadZone.classList.add('active');
        }
        
        // 处理拖放 - 离开时
        function handleDragLeave() {
            uploadZone.classList.remove('active');
        }
        
        // 处理拖放 - 放下时
        function handleDrop(e) {
            e.preventDefault();
            uploadZone.classList.remove('active');
            
            const files = e.dataTransfer.files;
            if (!files.length) return;
            
            // 将拖放的文件分配给文件输入
            const dataTransfer = new DataTransfer();
            for (let i = 0; i < files.length; i++) {
                dataTransfer.items.add(files[i]);
            }
            fileInput.files = dataTransfer.files;
            
            // 触发文件上传处理
            const event = new Event('change');
            fileInput.dispatchEvent(event);
        }
        
        // 处理音频文件 - 读取元数据并保存
        async function processAudioFile(file) {
            try {
                // 检查文件是否已存在
                const fileHash = await calculateFileHash(file);
                const existingIndex = musicLibrary.findIndex(song => song.hash === fileHash);
                if (existingIndex !== -1) {
                    console.log(`文件已存在: ${musicLibrary[existingIndex].title}`);
                    return;
                }
                
                // 读取音乐元数据
                const metadata = await musicMetadata.parseBlob(file);
                
                // 提取元数据信息
                const title = metadata.common.title || file.name.replace(/\.[^/.]+$/, "");
                const artist = metadata.common.artist || "未知艺术家";
                const album = metadata.common.album || "未知专辑";
                const duration = metadata.format.duration || 0;
                const durationFormatted = formatDuration(duration);
                
                // 处理专辑封面
                let coverUrl = "https://picsum.photos/id/" + (1000 + musicLibrary.length) + "/300/300";
                if (metadata.common.picture && metadata.common.picture.length > 0) {
                    const picture = metadata.common.picture[0];
                    coverUrl = URL.createObjectURL(new Blob([picture.data], { type: picture.format }));
                }
                
                // 转换文件为Base64以便存储（仅适用于小型文件）
                const base64Data = await fileToBase64(file);
                
                // 创建歌曲对象
                const song = {
                    id: Date.now() + Math.floor(Math.random() * 1000),
                    hash: fileHash,
                    title,
                    artist,
                    album,
                    duration,
                    durationFormatted,
                    coverUrl,
                    fileType: file.type,
                    fileSize: file.size,
                    fileData: base64Data,
                    addedAt: new Date().toISOString()
                };
                
                // 添加到音乐库
                musicLibrary.push(song);
                
                // 保存到本地存储
                saveMusicLibrary();
                
            } catch (error) {
                console.error("处理音频文件时出错:", error);
                alert(`处理文件 ${file.name} 时出错: ${error.message}`);
            }
        }
        
        // 计算文件哈希（用于检测重复文件）
        function calculateFileHash(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // 简单哈希计算（实际应用中可使用更复杂的算法）
                    let hash = 0;
                    const data = e.target.result;
                    for (let i = 0; i < data.length; i++) {
                        const char = data.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash; // 转换为32位整数
                    }
                    resolve(Math.abs(hash).toString(16));
                };
                reader.onerror = reject;
                // 只读取文件的前1024字节和后1024字节用于哈希计算
                const blob = file.slice(0, 1024);
                reader.readAsBinaryString(blob);
            });
        }
        
        // 文件转换为Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // 从本地存储加载音乐库
        function loadMusicLibrary() {
            try {
                const saved = localStorage.getItem('musicLibrary');
                if (saved) {
                    musicLibrary = JSON.parse(saved);
                    updateMusicLibraryUI();
                }
            } catch (error) {
                console.error("加载音乐库失败:", error);
                musicLibrary = [];
            }
        }
        
        // 保存音乐库到本地存储
        function saveMusicLibrary() {
            try {
                localStorage.setItem('musicLibrary', JSON.stringify(musicLibrary));
            } catch (error) {
                console.error("保存音乐库失败:", error);
                alert("保存音乐失败，可能是因为文件太大或存储空间不足");
            }
        }
        
        // 更新音乐库UI
        function updateMusicLibraryUI() {
            // 更新歌曲计数
            songCount.textContent = `${musicLibrary.length} 首歌曲`;
            
            // 显示或隐藏空库提示
            if (musicLibrary.length === 0) {
                emptyLibrary.classList.remove('hidden');
                songList.classList.add('hidden');
                disablePlayerControls();
                return;
            }
            
            // 显示歌曲列表
            emptyLibrary.classList.add('hidden');
            songList.classList.remove('hidden');
            enablePlayerControls();
            
            // 清空列表
            songList.innerHTML = '';
            
            // 添加歌曲项
            musicLibrary.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = `song-item px-6 py-4 flex items-center justify-between ${index === currentSongIndex ? 'bg-primary/5' : ''}`;
                li.innerHTML = `
                    <div class="flex items-center">
                        <img src="${song.coverUrl}" alt="${song.album}" class="w-12 h-12 rounded object-cover mr-4">
                        <div>
                            <div class="font-medium truncate max-w-xs sm:max-w-md">${song.title}</div>
                            <div class="text-sm text-gray-500">${song.artist} • ${song.album}</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-500">${song.durationFormatted}</span>
                        <button class="play-song-btn text-gray-500 hover:text-primary transition-colors" data-index="${index}">
                            ${index === currentSongIndex && !audioPlayer.paused ? 
                                '<i class="fa fa-pause"></i>' : 
                                '<i class="fa fa-play"></i>'}
                        </button>
                        <button class="delete-song-btn text-gray-400 hover:text-red-500 transition-colors" data-index="${index}">
                            <i class="fa fa-trash-o"></i>
                        </button>
                    </div>
                `;
                
                // 播放按钮事件
                li.querySelector('.play-song-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    playSong(index);
                });
                
                // 删除按钮事件
                li.querySelector('.delete-song-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteSong(index);
                });
                
                // 点击整个行播放歌曲
                li.addEventListener('click', () => playSong(index));
                
                songList.appendChild(li);
            });
        }
        
        // 播放指定歌曲
        function playSong(index) {
            if (index < 0 || index >= musicLibrary.length) return;
            
            // 如果点击的是当前播放的歌曲，则切换播放/暂停状态
            if (index === currentSongIndex && !audioPlayer.paused) {
                togglePlayPause();
                return;
            }
            
            // 更新当前索引
            currentSongIndex = index;
            const song = musicLibrary[index];
            
            // 更新播放器信息
            currentTitle.textContent = song.title;
            currentArtist.textContent = `${song.artist} • ${song.album}`;
            albumCover.src = song.coverUrl;
            totalTimeEl.textContent = song.durationFormatted;
            
            // 加载并播放歌曲
            audioPlayer.src = song.fileData;
            audioPlayer.load();
            audioPlayer.play();
            
            // 更新播放按钮状态
            updatePlayButtonState();
            
            // 更新歌曲列表UI
            updateMusicLibraryUI();
        }
        
        // 切换播放/暂停
        function togglePlayPause() {
            if (audioPlayer.paused) {
                audioPlayer.play();
            } else {
                audioPlayer.pause();
            }
            updatePlayButtonState();
            updateMusicLibraryUI();
        }
        
        // 更新播放按钮状态
        function updatePlayButtonState() {
            if (audioPlayer.paused) {
                playPauseBtn.innerHTML = '<i class="fa fa-play text-xl"></i>';
            } else {
                playPauseBtn.innerHTML = '<i class="fa fa-pause text-xl"></i>';
            }
        }
        
        // 播放上一首
        function playPreviousSong() {
            if (musicLibrary.length === 0) return;
            
            const newIndex = currentSongIndex > 0 ? currentSongIndex - 1 : musicLibrary.length - 1;
            playSong(newIndex);
        }
        
        // 播放下一首
        function playNextSong() {
            if (musicLibrary.length === 0) return;
            
            const newIndex = currentSongIndex < musicLibrary.length - 1 ? currentSongIndex + 1 : 0;
            playSong(newIndex);
        }
        
        // 更新进度条
        function updateProgress() {
            if (isDragging || isNaN(audioPlayer.duration)) return;
            
            const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressFill.style.width = `${percent}%`;
            
            // 更新当前时间显示
            currentTimeEl.textContent = formatDuration(audioPlayer.currentTime);
        }
        
        // 跳转到指定进度
        function seekTo(e) {
            const rect = progressBar.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = pos * audioPlayer.duration;
            updateProgress();
        }
        
        // 调整音量
        function adjustVolume() {
            audioPlayer.volume = volumeSlider.value / 100;
            updateVolumeIcon();
        }
        
        // 切换静音
        function toggleMute() {
            audioPlayer.muted = !audioPlayer.muted;
            updateVolumeIcon();
        }
        
        // 更新音量图标
        function updateVolumeIcon() {
            if (audioPlayer.muted) {
                muteBtn.innerHTML = '<i class="fa fa-volume-off"></i>';
            } else if (audioPlayer.volume < 0.5) {
                muteBtn.innerHTML = '<i class="fa fa-volume-down"></i>';
            } else {
                muteBtn.innerHTML = '<i class="fa fa-volume-up"></i>';
            }
        }
        
        // 删除歌曲
        function deleteSong(index) {
            if (confirm(`确定要删除 "${musicLibrary[index].title}" 吗？`)) {
                // 如果删除的是当前播放的歌曲
                const wasPlayingCurrent = index === currentSongIndex;
                
                // 从库中移除
                musicLibrary.splice(index, 1);
                
                // 更新当前索引
                if (wasPlayingCurrent) {
                    currentSongIndex = -1;
                    audioPlayer.pause();
                    audioPlayer.src = '';
                    updatePlayButtonState();
                    
                    // 如果还有歌曲，播放第一首
                    if (musicLibrary.length > 0) {
                        playSong(0);
                    } else {
                        // 重置播放器显示
                        currentTitle.textContent = "未播放音乐";
                        currentArtist.textContent = "请上传音乐文件开始播放";
                        albumCover.src = "https://picsum.photos/id/1074/300/300";
                        totalTimeEl.textContent = "0:00";
                        progressFill.style.width = "0%";
                        currentTimeEl.textContent = "0:00";
                    }
                } else if (index < currentSongIndex) {
                    // 如果删除的是当前歌曲之前的歌曲，调整索引
                    currentSongIndex--;
                }
                
                // 保存并更新UI
                saveMusicLibrary();
                updateMusicLibraryUI();
            }
        }
        
        // 格式化时长（秒 -> mm:ss）
        function formatDuration(seconds) {
            if (isNaN(seconds)) return "0:00";
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' + secs : secs}`;
        }
        
        // 显示加载状态
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
            emptyLibrary.classList.add('hidden');
            songList.classList.add('hidden');
        }
        
        // 隐藏加载状态
        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }
        
        // 启用播放器控制
        function enablePlayerControls() {
            playPauseBtn.disabled = false;
            prevBtn.disabled = false;
            nextBtn.disabled = false;
            muteBtn.disabled = false;
            volumeSlider.disabled = false;
        }
        
        // 禁用播放器控制
        function disablePlayerControls() {
            playPauseBtn.disabled = true;
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            muteBtn.disabled = true;
            volumeSlider.disabled = true;
        }
    </script>
</body>
</html>
    
